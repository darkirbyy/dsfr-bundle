{% from '@DarkirbyDsfr/component/macro.html.twig' import attribute_deep, data_param %}

{% set datatableId = datatableId is defined ? datatableId : 'datatable-0' %}

<div class="datatable" data-controller="datatable" data-datatable-options-value="{{ datatableOptions|default({ paging: true })|json_encode }}">
  <div class="datatable-space-between">
    <div class="datatable-search">
      {% if datatableOptions.searching ?? true %}
        <div class="fr-search-bar" role="search">
          <label class="fr-label" for="datatable-search">Recherche</label>
          <input class="fr-input" data-datatable-target="searchInput" placeholder="Recherche" type="search" name="datatable-search" />
          <button class="fr-btn" data-datatable-target="searchButton" title="Rechercher">Rechercher</button>
        </div>
      {% endif %}
    </div>
    <div>
      {% if datatableOptions.exporting ?? true %}
        <button class="fr-btn fr-btn--sm fr-btn--secondary fr-btn--icon-left fr-icon-file-download-fill" data-datatable-target="exportPdfButton" title="Export en PDF">PDF</button>
        <button class="fr-btn fr-btn--sm fr-btn--secondary fr-btn--icon-left fr-icon-file-download-fill" data-datatable-target="exportCsvButton" title="Export en CSV">CSV</button>
      {% endif %}
    </div>
  </div>

  <div class="fr-table fr-table--bordered">
    <div class="fr-table__wrapper">
      <div class="fr-table__container">
        <div class="fr-table__content">
          <table class="fr-cell--multiline" id="{{ datatableId }}">
            {% if datatableContent is defined %}
              {{ datatableContent|raw }}
            {% else %}
              <thead>
                <tr>
                  {# En-tête de la colonne de sélection #}
                  {% if datatableOptions.selecting ?? false %}
                    {% set selectAllId = datatableId ~ '-select-all' %}

                    <th class="fr-cell--fixed" role="columnheader" data-datatable-column="0" data-datatable-target="visible">
                      <div class="fr-checkbox-group fr-checkbox-group--sm">
                        <input id="{{ selectAllId }}" type="checkbox" data-datatable-target="selectAllCheckbox" />
                        <label class="fr-label" for="{{ selectAllId }}">Tous</label>
                      </div>
                    </th>
                  {% endif %}

                  {% for column in datatableColumns %}
                    {% set target = (column.visible ?? true ? 'visible') ~ (column.exportable ?? true ? ' exportable') ~ (column.searchable ?? false ? ' searchable')
                      ~ (column.sortable ?? false ? ' sortable')
                      ~ (column.filtrable ?? false ? ' filtrable')
                    %}
                    {# En-tête des colonnes définies avec les targets adaptées + attribut html pour l'index de la column et le tri initial selon sortInit #}
                    {% set data_param %}
                      scope="col" data-datatable-column="{{ datatableOptions.selecting ?? false ? loop.index : loop.index0 }}" data-datatable-target="{{ target }}"{% if
                        column.sortInit is defined and column.sortInit in ['asc', 'desc'] %}
                        data-datatable-sort-init="{{ column.sortInit }}"
                      {% endif %}
                      {% if column.class is defined %}
                        class="{{ column.class }}"
                      {% endif %}
                    {% endset %}

                    <th {{ data_param }}>
                      <div class="fr-cell--sort">
                        {# Libellé de la colonne avec tooltip ou non #}
                        {% if column.tooltip is defined %}
                          {% set tooltipId = datatableId ~ '-tooltip-' ~ loop.index0 %}
                          <span class="fr-cell__title" aria-describedby="{{ tooltipId }}">{{ column.label }}</span>
                          <span class="fr-tooltip fr-placement" id="{{ tooltipId }}" role="tooltip" aria-hidden="true">{{ column.tooltip }}</span>
                        {% else %}
                          <span class="fr-cell__title">{{ column.label }}</span>
                        {% endif %}

                        {# Bouton + menu pour une colonne filtrable #}
                        {% if column.filtrable ?? false %}
                          {% set filterId = datatableId ~ '-filter-' ~ loop.index0 %}
                          <div class="datatable-filter">
                            {# Bouton pour afficher/cacher le menu contenant les filtres #}
                            <button type="button" id="{{ filterId }}" data-datatable-button="filter" aria-haspopup="true" aria-expanded="false" class="fr-btn fr-btn--sm">
                              Filtrer par
                              {{ column.label|lower }}
                            </button>
                            {# Détermine le type de filtre et les valeurs initialement cochées #}
                            {% set filterType = column.filterType is defined and column.filterType in ['checkbox', 'radio'] ? column.filterType : 'checkbox' %}
                            {% set filterMode = column.filterMode is defined and column.filterMode in ['range', 'normal'] ? column.filterMode : 'normal' %}
                            {% set filterInit = column.filterInit is defined ? column.filterInit : [] %}
                            {% if filterType == 'radio' and filterInit is empty %}
                              {% set filterInit = [column.filterChoices|first] %}
                            {% endif %}

                            <fieldset class="fr-fieldset fr-card--shadow fr-hidden" aria-labelledby="{{ filterId }}" data-datatable-filter-mode="{{ filterMode }}" role="menu">
                              <a href="#" class="fr-link fr-link--sm">Tout décocher</a>

                              {# Génère les différentes options du filtres selon filterChoices, en radio ou checkbox selon filterType, et préselectionne certaines selon filterInit #}
                              {% for filterChoice in column.filterChoices %}
                                {% set filterChoiceId = filterId ~ '-choice-' ~ loop.index0 %}
                                {% set is_checked = (filterType == 'checkbox' and filterChoice.label not in filterInit)
                                  or (filterType == 'radio' and filterChoice.label in filterInit)
                                %}
                                <div class="fr-fieldset__element">
                                  <div class="fr-{{ filterType }}-group fr-{{ filterType }}-group--sm">
                                    {% set input_param %}
                                      {% if filterMode == 'range' %}
                                        data-datatable-value-min="{{ filterChoice.valueMin }}" data-datatable-value-max="{{ filterChoice.valueMax }}"
                                      {% else %}
                                        data-datatable-value="{{ filterChoice.value }}"
                                      {% endif %}
                                    {% endset %}
                                    <input name="{{ filterId }}" id="{{ filterChoiceId }}" type="{{ filterType }}" {{ is_checked ? 'checked' }} {{ input_param }} />
                                    <label class="fr-label" for="{{ filterChoiceId }}">{{ filterChoice.label is not empty ? filterChoice.label : '<em>Vide</em>' }}</label>
                                  </div>
                                </div>
                              {% endfor %}
                            </fieldset>
                          </div>
                        {% endif %}

                        {# Bouton + menu pour une colonne triable #}
                        {% if column.sortable ?? false %}
                          {% set sortId = datatableId ~ '-sort-' ~ loop.index0 %}
                          <button type="button" class="fr-btn--sort fr-btn fr-btn--sm" data-datatable-button="sort" id="{{ sortId }}">
                            Trier par
                            {{ column.label|lower }}
                          </button>
                        {% endif %}
                      </div>
                    </th>
                  {% endfor %}
                </tr>
              </thead>
              <tbody>
                {# Une nouvelle ligne pour chaque objet #}
                {% for object in objects %}
                  <tr data-row-key="{{ loop.index }}" style="--row-height: 50px;">
                    {# Première colonne de sélection #}
                    {% if datatableOptions.selecting ?? false %}
                      {% set selectId = datatableId ~ '-select-' ~ loop.index %}
                      <th class="fr-cell--fixed" scope="row">
                        <div class="fr-checkbox-group fr-checkbox-group--sm">
                          <input
                            data-fr-row-select="true"
                            id="{{ selectId }}"
                            type="checkbox"
                            data-datatable-target="selectCheckbox"
                            data-datatable-row-id="{{ attribute_deep(object, datatableOptions.selectingProperty|default('id'))|trim }}"
                          />
                          <label class="fr-label" for="{{ selectId }}">{{ loop.index }}</label>
                        </div>
                      </th>
                    {% endif %}
                    {# Autres colonnes de valeurs définies #}
                    {% for column in datatableColumns %}
                      {# HTML data param #}
                      {% set data_param %}
                        {% set sortable = column.sortable ?? false %}
                        {% if sortable and column.sortProperty is defined %}
                          data-order="{{ attribute_deep(object, column.sortProperty)|trim }}"
                        {% endif %}

                        {% set filtrable = column.filtrable ?? false %}
                        {% if filtrable %}
                          data-filter="{{ attribute_deep(object, column.filterProperty|default(column.property))|trim }}"
                        {% endif %}

                        {% set exportable = column.exportable ?? true %}
                        {% if exportable and column.exportProperty is defined %}
                          data-export="{{ attribute_deep(object, column.exportProperty)|trim }}"
                        {% endif %}
                      {% endset %}

                      {# Valeur affichée #}
                      <td {{ data_param }}>
                        {% if column.custom|default(false) %}
                          {% with { path: customFilePath, block: column.property, object: object, param: customParam|default({ }) } only %}
                          {{ block(block, path) }}
                          {% endwith %}
                        {% else %}
                          {{ attribute_deep(object, column.property)|trim }}
                        {% endif %}
                      </td>
                    {% endfor %}
                  </tr>
                {% endfor %}
              </tbody>
            {% endif %}
          </table>
        </div>
      </div>
    </div>
  </div>

  <div class="datatable-space-between">
    <div class="fr-mx-3v fr-text--sm" data-datatable-target="records">
      x lignes
    </div>
    {% if datatableOptions.paging ?? true %}
      <nav role="navigation" class="fr-pagination" aria-label="Pagination">
        <ul class="fr-pagination__list">
          <li><a class="fr-pagination__link fr-pagination__link--first" role="link" data-datatable-target="pageFirst">Première page</a></li>
          <li><a class="fr-pagination__link fr-pagination__link--prev fr-pagination__link--lg-label" role="link" data-datatable-target="pagePrev">Page précédente</a></li>
          <li><span class="fr-pagination__link fr-displayed-lg" data-datatable-target="pageEllipsisBefore">…</span></li>
          <li><a class="fr-pagination__link fr-displayed-lg" href="#" data-datatable-target="pageBefore">n-1</a></li>
          <li><a class="fr-pagination__link" data-datatable-target="pageCurrent" aria-current="page">n</a></li>
          <li><a class="fr-pagination__link fr-displayed-lg" href="#" data-datatable-target="pageAfter">n+1</a></li>
          <li><span class="fr-pagination__link fr-displayed-lg" data-datatable-target="pageEllipsisAfter">…</span></li>
          <li><a class="fr-pagination__link fr-pagination__link--next fr-pagination__link--lg-label" data-datatable-target="pageNext">Page suivante</a></li>
          <li><a class="fr-pagination__link fr-pagination__link--last" data-datatable-target="pageLast">Dernière page</a></li>
        </ul>
      </nav>
    {% endif %}
  </div>
</div>
